<!doctype html>
<html>
  {% include head.html %}
  <body>
    {% include header.html %}


    <main class="content">
      <form class="search">
        <input type="text" placeholder="Search (beta)...">
        <ul></ul>
      </form>
      <div class="card">
        <div class="courses">
          <a class="courses__out" href="https://ultimateangular.com?utm_source=toddmotto.com" target="_blank">
            <div class="courses__a1"></div>
            <div class="courses__a2"></div>
            <img class="courses__logo" src="{{ site.baseurl }}/img/courses-logo.png" alt="">
            <h3>
              Master Angular 1.x and Angular 2 with me online
            </h3>
            <p>
              Limited Angular 2 preorders now available.<br>Master the latest Angular 1.5 components, or dive straight into mastering Angular 2
            </p>
            <button type="button">
              See the packages
            </button>
          </a>
          <script>
            (function () {
              var banner = document.querySelector('.courses__out');
              if (!banner) return;
              var url = window.location.pathname;
              banner.href = banner.href + url;
            })();
            (function () {

              var cache;
              var fetched = false;

              function debounce(fn, delay) {
                var timer = null;
                return function () {
                  var context = this, args = arguments;
                  clearTimeout(timer);
                  timer = setTimeout(function () {
                    fn.apply(context, args);
                  }, delay);
                };
              }

              function compile(tmpl) {
                var node = document.createElement('div');
                node.innerHTML = tmpl;
                return node.childNodes[0];
              }

              function getResult(result) {
                return compile([
                  '<li>',
                    '<a href="' + result.url + '">',
                      // the .replace() is an ugly hack right now
                      // to remove &amp; before &amp;#58; for example
                      // which otherwise will not render colons in the DOM
                      result.title.replace(/\&amp\;/, '&'),
                    '</a>',
                  '</li>'
                ].join(''));
              }

              function destroyResults() {
                if (searchResults.querySelector('li')) {
                  searchResults.innerHTML = '';
                }
              }

              function renderResults(results) {
                var docFrag = document.createDocumentFragment();
                results.forEach(function (result) {
                  docFrag.appendChild(getResult(result));
                });
                searchResults.appendChild(docFrag);
              }

              function showNoResults() {
                searchResults.innerHTML = '<li><a href="#">No results. Search for entire words, i.e. "forms"</a></li>'
              }

              function render(collection) {
                destroyResults();
                if (collection.length) {
                  renderResults(collection);
                } else {
                  showNoResults();
                }
              }

              function filterStore(store, filter) {
                var regexp = new RegExp('\\b' + filter + '\\b', 'gi');
                return store.filter(function(item) {
                  return (
                    regexp.test(item.title) ?
                    item :
                    (
                      regexp.test(item.content) ?
                      item :
                      null
                    )
                  );
                });
              }

              function parse (req) {
                var result;
                try {
                  result = JSON.parse(req.responseText);
                } catch (e) {
                  result = req.responseText;
                }
                return [result, req];
              };

              function xhr(type, url, data) {
                var methods = {
                  success: function () {},
                  error: function () {},
                  always: function () {}
                };
                var XHR = window.XMLHttpRequest || ActiveXObject;
                var request = new XHR('MSXML2.XMLHTTP.3.0');

                request.open(type, url, true);
                request.setRequestHeader('Content-type', {
                  contentType: 'application/x-www-form-urlencoded'
                });
                request.onreadystatechange = function () {
                  var req;
                  if (request.readyState === 4) {
                    req = parse(request);
                    if (request.status >= 200 && request.status < 300) {
                      methods.success.apply(methods, req);
                    } else {
                      methods.error.apply(methods, req);
                    }
                  }
                };
                request.send(data);

                var atomXHR = {
                  success: function (callback) {
                    methods.success = callback;
                    return atomXHR;
                  },
                  error: function (callback) {
                    methods.error = callback;
                    return atomXHR;
                  }
                };
                return atomXHR;
              };

              var search = document.querySelector('.search');
              var searchInput = search.querySelector('input');
              var searchResults = search.querySelector('ul');

              function isChild(elem, parent) {
                var node = elem.parentNode;
                while (node !== null) {
                  if (node === parent) {
                    return true;
                  }
                  node = node.parentNode;
                }
                return false;
              }

              function handleOffClick(event) {
                if (!isChild(event.target, search)) {
                  destroyResults();
                }
              }

              function handleSearch() {
                var searchValue = searchInput.value;
                if (!searchValue) {
                  destroyResults();
                  return;
                };
                if (fetched) {
                  render(filterStore(cache, searchValue));
                  return;
                }
                var request = new xhr('GET', '/posts.json');
                request
                  .success(function (response) {
                    var filtered = filterStore(response, searchValue);
                    render(filtered);
                    cache = response;
                    fetched = true;
                  })
                  .error(function (reason) {
                    fetched = false;
                  });
              }

              searchInput.addEventListener('focus', handleSearch, false);
              searchInput.addEventListener('input', function () {
                debounce(handleSearch, fetched ? 0 : 250)();
              }, false);
              search.addEventListener('submit', function handleSubmit(event) { event.preventDefault() }, false);
              document.addEventListener('click', handleOffClick, false);

            })();
          </script>
        </div>

        <div class="card__content">
          {{ content }}
        </div>
      </div>
      {% include footer.html %}
    </main>
  </body>
</html>
